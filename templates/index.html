<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tajweed Teacher</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <button class="theme-toggle" id="themeToggle" title="Toggle dark mode">ğŸŒ™</button>

    <div class="header">
        <h1>AI Tajweed Teacher</h1>
        <h2>Surah Al-Fatiha</h2>
    </div>

    <div class="container">
        <div class="tajweed-legend">
            <h3>Tajweed Rules Guide</h3>
            <div class="legend-items">
                <div class="legend-item" data-tooltip="A nasal sound made for 2 counts when certain letters have a shaddah">
                    <div class="color-box" style="background-color: var(--ghunnah-color)"></div>
                    <span>Ghunnah</span>
                </div>
                <div class="legend-item" data-tooltip="When one letter merges into another, creating a doubled/emphasized sound">
                    <div class="color-box" style="background-color: var(--idghaam-color)"></div>
                    <span>Idghaam</span>
                </div>
                <div class="legend-item" data-tooltip="A bouncing sound that occurs on certain letters when they have a sukoon or stop on them">
                    <div class="color-box" style="background-color: var(--qalqalah-color)"></div>
                    <span>Qalqalah</span>
                </div>
                <div class="legend-item" data-tooltip="Elongation of certain vowel sounds for 2, 4, or 6 counts">
                    <div class="color-box" style="background-color: var(--madd-color)"></div>
                    <span>Madd</span>
                </div>
                <div class="legend-item" data-tooltip="Partial concealment of noon sakinah or tanween when followed by certain letters">
                    <div class="color-box" style="background-color: var(--ikhfa-color)"></div>
                    <span>Ikhfa</span>
                </div>
                <div class="legend-item" data-tooltip="Converting noon sakinah or tanween into a hidden meem sound when followed by ba">
                    <div class="color-box" style="background-color: var(--iqlab-color)"></div>
                    <span>Iqlab</span>
                </div>
            </div>
        </div>

        <div class="surah-container">
            <div class="ayah" data-ayah="0" data-text="Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù">
                <div class="ayah-number">Ù </div>
                <div class="ayah-content">
                    <p class="arabic">
                        <span class="word" data-word="Ø¨ÙØ³Ù’Ù…Ù">Ø¨ÙØ³Ù’Ù…Ù</span>
                        <span class="word" data-word="Ù±Ù„Ù„ÙÙ‘Ù‡Ù">Ù±Ù„Ù„ÙÙ‘Ù‡Ù</span>
                        <span class="word" data-word="Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù">Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù</span>
                        <span class="word" data-word="Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù">Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</span>
                    </p>
                    <p class="translation">In the name of Allah, the Most Gracious, the Most Merciful</p>
                    <p class="transliteration">BismillÄhi r-raá¸¥mÄni r-raá¸¥Ä«m</p>
                </div>
                <div class="feedback"></div>
            </div>
            <div class="ayah" data-ayah="1">
                <div class="ayah-number">Ù¡</div>
                <div class="ayah-content">
                    <p class="arabic">
                        Ù±Ù„Ù’Ø­ÙÙ…Ù’Ø¯Ù Ù„ÙÙ„ÙÙ‘Ù‡Ù Ø±ÙØ¨ÙÙ‘ 
                        <span class="madd">Ù±Ù„Ù’Ø¹ÙÙ°Ù„ÙÙ…ÙÙŠÙ†Ù</span>
                    </p>
                    <p class="translation">All praise is due to Allah, Lord of the worlds</p>
                    <p class="transliteration">Al-á¸¥amdu lillÄhi rabbi l-Ê¿ÄlamÄ«n</p>
                </div>
                <div class="feedback"></div>
            </div>
            <div class="ayah" data-ayah="2">
                <div class="ayah-number">Ù¢</div>
                <div class="ayah-content">
                    <p class="arabic">Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</p>
                    <p class="translation">The Most Gracious, the Most Merciful</p>
                    <p class="transliteration">Ar-raá¸¥mÄni r-raá¸¥Ä«m</p>
                </div>
                <div class="feedback"></div>
            </div>
            <div class="ayah" data-ayah="3">
                <div class="ayah-number">Ù£</div>
                <div class="ayah-content">
                    <p class="arabic">
                        <span class="qalqalah">Ù…ÙÙ°Ù„ÙÙƒÙ</span> 
                        ÙŠÙÙˆÙ’Ù…Ù Ù±Ù„Ø¯ÙÙ‘ÙŠÙ†Ù
                    </p>
                    <p class="translation">Master of the Day of Judgment</p>
                    <p class="transliteration">MÄliki yawmi d-dÄ«n</p>
                </div>
                <div class="feedback"></div>
            </div>
            <div class="ayah" data-ayah="4">
                <div class="ayah-number">Ù¤</div>
                <div class="ayah-content">
                    <p class="arabic">Ø¥ÙÙŠÙÙ‘Ø§ÙƒÙ Ù†ÙØ¹Ù’Ø¨ÙØ¯Ù ÙˆÙØ¥ÙÙŠÙÙ‘Ø§ÙƒÙ Ù†ÙØ³Ù’ØªÙØ¹ÙÙŠÙ†Ù</p>
                    <p class="translation">You alone we worship, and You alone we ask for help</p>
                    <p class="transliteration">IyyÄka naÊ¿budu wa-iyyÄka nastaÊ¿Ä«n</p>
                </div>
                <div class="feedback"></div>
            </div>
            <div class="ayah" data-ayah="5">
                <div class="ayah-number">Ù¥</div>
                <div class="ayah-content">
                    <p class="arabic">Ù±Ù‡Ù’Ø¯ÙÙ†ÙØ§ Ù±Ù„ØµÙÙ‘Ø±ÙÙ°Ø·Ù Ù±Ù„Ù’Ù…ÙØ³Ù’ØªÙÙ‚ÙÙŠÙ…Ù</p>
                    <p class="translation">Guide us to the straight path</p>
                    <p class="transliteration">IhdinÄ á¹£-á¹£irÄá¹­a l-mustaqÄ«m</p>
                </div>
                <div class="feedback"></div>
            </div>
            <div class="ayah" data-ayah="6">
                <div class="ayah-number">Ù¦</div>
                <div class="ayah-content">
                    <p class="arabic">
                        ØµÙØ±ÙÙ°Ø·Ù 
                        <span class="ghunnah">Ù±Ù„ÙÙ‘Ø°ÙÙŠÙ†Ù</span> 
                        Ø£ÙÙ†Ù’Ø¹ÙÙ…Ù’ØªÙ Ø¹ÙÙ„ÙÙŠÙ’Ù‡ÙÙ…Ù’ ØºÙÙŠÙ’Ø±Ù Ù±Ù„Ù’Ù…ÙØºÙ’Ø¶ÙÙˆØ¨Ù 
                        <span class="idghaam">Ø¹ÙÙ„ÙÙŠÙ’Ù‡ÙÙ…Ù’</span> 
                        ÙˆÙÙ„ÙØ§ Ù±Ù„Ø¶ÙÙ‘Ø¢Ù„ÙÙ‘ÙŠÙ†Ù
                    </p>
                    <p class="translation">The path of those upon whom You have bestowed favor, not of those who have earned anger or of those who have gone astray</p>
                    <p class="transliteration">á¹¢irÄá¹­a l-laá¸Ä«na anÊ¿amta Ê¿alayhim Ä¡ayri l-maÄ¡á¸Å«bi Ê¿alayhim wa-lÄ á¸-á¸ÄllÄ«n</p>
                </div>
                <div class="feedback"></div>
            </div>
        </div>

        <!-- Add Reference Audio Player Section -->
        <div class="reference-audio" style="margin: 20px 0; padding: 20px; background: var(--container-bg); border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-bottom: 15px;">Listen to Reference Recitation</h3>
            <div class="reference-controls" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <select id="reciterSelect" style="padding: 8px; border-radius: 5px; border: 1px solid var(--border-color);">
                    <option value="ayyoub">Sheikh Mohammad Ayyoub</option>
                    <option value="hudhaify">Sheikh Ali Al-Hudhaify</option>
                    <option value="maher">Sheikh Maher Al-Muaiqly</option>
                    <option value="minshawy">Sheikh Mohamed Siddiq El-Minshawi</option>
                    <option value="mishary">Sheikh Mishary Rashid Alafasy</option>
                </select>
                <select id="ayahSelect" style="padding: 8px; border-radius: 5px; border: 1px solid var(--border-color);">
                    <option value="1">Ayah 1 - Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</option>
                    <option value="2">Ayah 2 - Ù±Ù„Ù’Ø­ÙÙ…Ù’Ø¯Ù Ù„ÙÙ„ÙÙ‘Ù‡Ù Ø±ÙØ¨ÙÙ‘ Ù±Ù„Ù’Ø¹ÙÙ°Ù„ÙÙ…ÙÙŠÙ†Ù</option>
                    <option value="3">Ayah 3 - Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</option>
                    <option value="4">Ayah 4 - Ù…ÙÙ°Ù„ÙÙƒÙ ÙŠÙÙˆÙ’Ù…Ù Ù±Ù„Ø¯ÙÙ‘ÙŠÙ†Ù</option>
                    <option value="5">Ayah 5 - Ø¥ÙÙŠÙÙ‘Ø§ÙƒÙ Ù†ÙØ¹Ù’Ø¨ÙØ¯Ù ÙˆÙØ¥ÙÙŠÙÙ‘Ø§ÙƒÙ Ù†ÙØ³Ù’ØªÙØ¹ÙÙŠÙ†Ù</option>
                    <option value="6">Ayah 6 - Ù±Ù‡Ù’Ø¯ÙÙ†ÙØ§ Ù±Ù„ØµÙÙ‘Ø±ÙÙ°Ø·Ù Ù±Ù„Ù’Ù…ÙØ³Ù’ØªÙÙ‚ÙÙŠÙ…Ù</option>
                    <option value="7">Ayah 7 - ØµÙØ±ÙÙ°Ø·Ù Ù±Ù„ÙÙ‘Ø°ÙÙŠÙ†Ù Ø£ÙÙ†Ù’Ø¹ÙÙ…Ù’ØªÙ Ø¹ÙÙ„ÙÙŠÙ’Ù‡ÙÙ…Ù’ ØºÙÙŠÙ’Ø±Ù Ù±Ù„Ù’Ù…ÙØºÙ’Ø¶ÙÙˆØ¨Ù Ø¹ÙÙ„ÙÙŠÙ’Ù‡ÙÙ…Ù’ ÙˆÙÙ„ÙØ§ Ù±Ù„Ø¶ÙÙ‘Ø¢Ù„ÙÙ‘ÙŠÙ†Ù</option>
                </select>
                <button id="playReference" style="padding: 8px 16px; border-radius: 5px; background: var(--primary-color); color: white; border: none; cursor: pointer;">
                    <span class="icon">â–¶ï¸</span> Play
                </button>
                <audio id="referenceAudio" style="display: none;"></audio>
            </div>
        </div>

        <div class="controls">
            <button id="recordButton" class="record-btn">
                <span class="icon">ğŸ™ï¸</span>
                <span class="text">Start Recording</span>
            </button>
            <div id="recordingStatus" class="status"></div>
        </div>

        <div id="feedback" class="feedback-container"></div>
    </div>

    <script>
        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        
        // Set initial theme
        if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && prefersDarkScheme.matches)) {
            document.body.setAttribute('data-theme', 'dark');
            themeToggle.textContent = 'â˜€ï¸';
        }

        themeToggle.addEventListener('click', () => {
            if (document.body.getAttribute('data-theme') === 'dark') {
                document.body.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
                themeToggle.textContent = 'ğŸŒ™';
            } else {
                document.body.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = 'â˜€ï¸';
            }
        });

        // Recording functionality
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let currentAyah = null;
        let currentWord = null;
        
        // Reference Audio Player functionality
        const playReferenceBtn = document.getElementById('playReference');
        const referenceAudio = document.getElementById('referenceAudio');
        const reciterSelect = document.getElementById('reciterSelect');
        const ayahSelect = document.getElementById('ayahSelect');
        
        playReferenceBtn.addEventListener('click', () => {
            const reciter = reciterSelect.value;
            const ayah = ayahSelect.value;
            const audioUrl = `/reference-audio/${reciter}/${ayah}`;
            
            // Update button state
            if (referenceAudio.paused) {
                referenceAudio.src = audioUrl;
                referenceAudio.play()
                    .then(() => {
                        playReferenceBtn.innerHTML = '<span class="icon">â¸ï¸</span> Pause';
                    })
                    .catch(error => {
                        console.error('Error playing audio:', error);
                        alert('Error playing audio. Please try again.');
                    });
            } else {
                referenceAudio.pause();
                playReferenceBtn.innerHTML = '<span class="icon">â–¶ï¸</span> Play';
            }
        });
        
        referenceAudio.addEventListener('ended', () => {
            playReferenceBtn.innerHTML = '<span class="icon">â–¶ï¸</span> Play';
        });
        
        // When user changes reciter or ayah while playing, restart the audio
        reciterSelect.addEventListener('change', () => {
            if (!referenceAudio.paused) {
                playReferenceBtn.click(); // Stop current playback
                setTimeout(() => playReferenceBtn.click(), 100); // Start new playback
            }
        });
        
        ayahSelect.addEventListener('change', () => {
            if (!referenceAudio.paused) {
                playReferenceBtn.click(); // Stop current playback
                setTimeout(() => playReferenceBtn.click(), 100); // Start new playback
            }
        });

        // Function to highlight active ayah and word
        function highlightAyah(ayahNumber, word = null) {
            // Remove previous highlights
            document.querySelectorAll('.ayah.active').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.word.active').forEach(el => el.classList.remove('active'));
            
            // Highlight new ayah
            const ayah = document.querySelector(`.ayah[data-ayah="${ayahNumber}"]`);
            if (ayah) {
                ayah.classList.add('active');
                
                // Scroll to ayah smoothly
                ayah.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Highlight specific word if provided
                if (word) {
                    const wordEl = ayah.querySelector(`.word[data-word="${word}"]`);
                    if (wordEl) {
                        wordEl.classList.add('active');
                    }
                }
            }
        }

        document.getElementById('recordButton').addEventListener('click', async () => {
            const button = document.getElementById('recordButton');
            const status = document.getElementById('recordingStatus');
            const buttonText = button.querySelector('.text');
            const buttonIcon = button.querySelector('.icon');

            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    // Set up WebSocket connection for real-time transcription
                    const ws = new WebSocket(`ws://${window.location.host}/ws`);
                    
                    ws.onmessage = function(event) {
                        const data = JSON.parse(event.data);
                        if (data.ayah) {
                            highlightAyah(data.ayah, data.word);
                        }
                    };

                    mediaRecorder.ondataavailable = async (event) => {
                        audioChunks.push(event.data);
                        
                        // Send audio chunk for real-time processing
                        if (ws.readyState === WebSocket.OPEN) {
                            const chunk = new Blob([event.data], { type: 'audio/webm' });
                            ws.send(await chunk.arrayBuffer());
                        }
                    };

                    mediaRecorder.onstop = async () => {
                        ws.close();
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        await sendAudioToServer(audioBlob);
                    };

                    // Start recording with smaller time slices for more frequent updates
                    mediaRecorder.start(100);
                    isRecording = true;
                    buttonIcon.textContent = 'â¹';
                    buttonText.textContent = 'Stop Recording';
                    button.classList.add('recording');
                    status.textContent = 'Recording...';
                    
                } catch (err) {
                    console.error('Error accessing microphone:', err);
                    status.textContent = 'Error: Cannot access microphone';
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                buttonIcon.textContent = 'ğŸ™ï¸';
                buttonText.textContent = 'Start Recording';
                button.classList.remove('recording');
                status.textContent = 'Processing...';
            }
        });

        async function sendAudioToServer(audioBlob) {
            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.wav');

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('feedback').innerHTML = `
                        <h3>Recorded Recitation:</h3>
                        <p dir="rtl" class="arabic">${result.transcription}</p>
                        <h3>Tajweed Feedback:</h3>
                        <p>${result.feedback}</p>
                    `;
                } else {
                    document.getElementById('feedback').innerHTML = `
                        <p class="error">Error: ${result.error}</p>
                    `;
                }
            } catch (error) {
                console.error('Error sending audio:', error);
                document.getElementById('feedback').innerHTML = `
                    <p class="error">Error sending recording to server</p>
                `;
            } finally {
                document.getElementById('recordingStatus').textContent = '';
            }
        }
    </script>
</body>
</html> 